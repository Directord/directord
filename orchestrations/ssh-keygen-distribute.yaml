# This orchestration will deploy ssh keys and ensure all targets have
# a complete set of public keys from all other targets.
#
# NOTE(cloudnull): This orchestration highlights the power or "QUERY"
#                  which has the ability to notify targets of an "ARG"
#                  and how that ability can be leveraged within a simple
#                  blueprint.
#
---

- jobs:
  - ARG: director_ssh_folder /root/.ssh
  - RUN: >-
      [ -f ~/.ssh/id_rsa ] || ssh-keygen -q -b 2048 -t rsa -N '' -f "{{ director_ssh_folder }}/id_rsa"
  - RUN: --skip-cache --stdout-arg director_ssh_key cat "{{ director_ssh_folder }}/id_rsa.pub"
  - QUERY: director_ssh_key
  - ADD: --blueprint files/authorized_keys "{{ director_ssh_folder }}/authorized_keys"
