# NOTE(cloudnull): If no path is provided the system base path to the
#                  director "tools" directory is used.
shared_jobs: &shared_jobs
- ADD: prod-setup.sh prod-setup.sh
- RUN: sudo bash prod-setup.sh


director_server:
  targets:
  - host: 172.16.27.120
    port: 22
    username: centos
  jobs:
  - *shared_jobs
  - RUN: sudo /opt/director/bin/director manage --generate-keys
  - RUN: sudo /opt/director/bin/director-server-systemd
  - RUN: sudo systemctl daemon-reload
  - RUN: sudo systemctl restart director-server.service
  - GET: /etc/director/private_keys/client.key_secret /tmp/client.key_secret
  - GET: /etc/director/public_keys/client.key /tmp/client.key
  - GET: /etc/director/public_keys/server.key /tmp/server.key
  - RUN: |-
      sudo python3 <<EOC
      import yaml
      with open('/etc/director/config.yaml') as f:
          config = yaml.safe_load(f)
      config["curve_encryption"] = True
      with open('/etc/director/config.yaml', 'w') as f:
          f.write(yaml.safe_dump(config, default_flow_style=False))
      EOC

director_clients:
  args:
    port: 22
    username: centos
  targets:
  - host: 172.16.27.53
  - host: 172.16.27.58
  - host: 172.16.27.85
  - host: 172.16.27.113
  - host: 172.16.27.120
  - host: 172.16.27.137
  - host: 172.16.27.251
  jobs:
  - *shared_jobs
  - RUN: sudo mkdir -p /etc/director/private_keys /etc/director/public_keys
  - ADD: /tmp/client.key_secret /tmp/client.key_secret-stash
  - RUN: sudo mv /tmp/client.key_secret-stash /etc/director/private_keys/client.key_secret
  - ADD: /tmp/client.key /tmp/client.key-stash
  - RUN: sudo mv /tmp/client.key-stash /etc/director/public_keys/client.key
  - ADD: /tmp/server.key /tmp/server.key-stash
  - RUN: sudo mv /tmp/server.key-stash /etc/director/public_keys/server.key
  - RUN: sudo /opt/director/bin/director-client-systemd
  - RUN: sudo systemctl daemon-reload
  - RUN: |-
      sudo python3 <<EOC
      import yaml
      with open('/etc/director/config.yaml') as f:
          config = yaml.safe_load(f)
      config["curve_encryption"] = True
      config['server_address'] = "172.16.27.120"
      with open('/etc/director/config.yaml', 'w') as f:
          f.write(yaml.safe_dump(config, default_flow_style=False))
      EOC
  - RUN: sudo systemctl restart director-client.service
